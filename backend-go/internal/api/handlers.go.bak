package api

import (
	"encoding/json"
	"fmt"
	"net/http"
	"strconv"
	"time"

	"gymates/internal/models"
	"gymates/internal/services"

	"github.com/gin-gonic/gin"
)

type Handlers struct {
	userService     *services.UserService
	authService     *services.AuthService
	trainingService *services.TrainingService
	aiService       *services.AIService
	messageService  *services.MessageService
	teamService     *services.TeamService
}

func NewHandlers(
	userService *services.UserService,
	authService *services.AuthService,
	trainingService *services.TrainingService,
	aiService *services.AIService,
	messageService *services.MessageService,
	teamService *services.TeamService,
) *Handlers {
	return &Handlers{
		userService:     userService,
		authService:     authService,
		trainingService: trainingService,
		aiService:       aiService,
		messageService:  messageService,
		teamService:     teamService,
	}
}

// ç”¨æˆ·ç›¸å…³API
func (h *Handlers) Register(c *gin.Context) {
	var req models.RegisterRequest
	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	user, err := h.userService.Register(&req)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	c.JSON(http.StatusCreated, gin.H{
		"message": "æ³¨å†ŒæˆåŠŸ",
		"user":    user,
	})
}

func (h *Handlers) Login(c *gin.Context) {
	var req models.LoginRequest
	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	user, err := h.userService.Login(&req)
	if err != nil {
		c.JSON(http.StatusUnauthorized, gin.H{"error": err.Error()})
		return
	}

	// ç”ŸæˆJWT token (è¿™é‡Œéœ€è¦å®ç°JWTç”Ÿæˆé€»è¾‘)
	token := "mock-jwt-token"

	c.JSON(http.StatusOK, gin.H{
		"message": "ç™»å½•æˆåŠŸ",
		"token":   token,
		"user":    user,
	})
}

func (h *Handlers) ThirdPartyLogin(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "ç¬¬ä¸‰æ–¹ç™»å½•åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) CreateUserProfile(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "åˆ›å»ºç”¨æˆ·èµ„æ–™åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) GetUserProfile(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "è·å–ç”¨æˆ·èµ„æ–™åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) UpdateUserProfile(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "æ›´æ–°ç”¨æˆ·èµ„æ–™åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) DeleteUserProfile(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "åˆ é™¤ç”¨æˆ·èµ„æ–™åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) CheckUserProfileExists(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "æ£€æŸ¥ç”¨æˆ·èµ„æ–™å­˜åœ¨åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) AIRecommendTraining(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "AIæ¨èè®­ç»ƒåŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) GetGyms(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "è·å–å¥èº«æˆ¿åˆ—è¡¨åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) GetGymByID(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "è·å–å¥èº«æˆ¿è¯¦æƒ…åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) CreateGym(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "åˆ›å»ºå¥èº«æˆ¿åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) GetBuddies(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "è·å–æ­å­åˆ—è¡¨åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) AddBuddy(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "æ·»åŠ æ­å­åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) RemoveBuddy(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "ç§»é™¤æ­å­åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) GetTrainingPlans(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "è·å–è®­ç»ƒè®¡åˆ’åˆ—è¡¨åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) CreateTrainingPlan(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "åˆ›å»ºè®­ç»ƒè®¡åˆ’åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) GetTrainingPlan(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "è·å–è®­ç»ƒè®¡åˆ’è¯¦æƒ…åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) UpdateTrainingPlan(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "æ›´æ–°è®­ç»ƒè®¡åˆ’åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) DeleteTrainingPlan(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "åˆ é™¤è®­ç»ƒè®¡åˆ’åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) GetCommunityPosts(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "è·å–ç¤¾åŒºåŠ¨æ€åˆ—è¡¨åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) CreateCommunityPost(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "åˆ›å»ºç¤¾åŒºåŠ¨æ€åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) GetCommunityPost(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "è·å–ç¤¾åŒºåŠ¨æ€è¯¦æƒ…åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) UpdateCommunityPost(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "æ›´æ–°ç¤¾åŒºåŠ¨æ€åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) DeleteCommunityPost(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "åˆ é™¤ç¤¾åŒºåŠ¨æ€åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) LikeCommunityPost(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "ç‚¹èµç¤¾åŒºåŠ¨æ€åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) CommentCommunityPost(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "è¯„è®ºç¤¾åŒºåŠ¨æ€åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) GetGymBuddies(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "è·å–å¥èº«æˆ¿æ­å­åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) StartRest(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "å¼€å§‹ä¼‘æ¯åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) EndRest(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "ç»“æŸä¼‘æ¯åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) GetRestSessions(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "è·å–ä¼‘æ¯ä¼šè¯åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) GetRestFeed(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "è·å–ä¼‘æ¯åŠ¨æ€æµåŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) CreateRestPost(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "åˆ›å»ºä¼‘æ¯åŠ¨æ€åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) LikeRestPost(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "ç‚¹èµä¼‘æ¯åŠ¨æ€åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) CommentRestPost(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "è¯„è®ºä¼‘æ¯åŠ¨æ€åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) GetMessages(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "è·å–æ¶ˆæ¯åˆ—è¡¨åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) MarkMessageAsRead(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "æ ‡è®°æ¶ˆæ¯å·²è¯»åŠŸèƒ½æš‚æœªå®ç°"})
}

func (h *Handlers) MarkNotificationAsRead(c *gin.Context) {
	c.JSON(http.StatusNotImplemented, gin.H{"error": "æ ‡è®°é€šçŸ¥å·²è¯»åŠŸèƒ½æš‚æœªå®ç°"})
}

// ==================== æ­å­æ¨¡å—API ====================

// CreateTeam åˆ›å»ºæ­å­å›¢é˜Ÿ
func (h *Handlers) CreateTeam(c *gin.Context) {
	userIDStr := c.GetString("user_id")
	userID, err := strconv.ParseUint(userIDStr, 10, 64)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": "æ— æ•ˆçš„ç”¨æˆ·ID"})
		return
	}

	var req models.CreateTeamRequest
	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	team, err := h.teamService.CreateTeam(uint(userID), &req)
	if err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{
			"error":   "åˆ›å»ºæ­å­å›¢é˜Ÿå¤±è´¥",
			"details": err.Error(),
		})
		return
	}

	c.JSON(http.StatusCreated, gin.H{
		"message": "åˆ›å»ºæ­å­å›¢é˜ŸæˆåŠŸ",
		"data":    team,
	})
}

// GetTeams è·å–æ­å­å›¢é˜Ÿåˆ—è¡¨
func (h *Handlers) GetTeams(c *gin.Context) {
	page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
	limit, _ := strconv.Atoi(c.DefaultQuery("limit", "10"))

	teams, hasMore, err := h.teamService.GetTeams(page, limit)
	if err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{
			"error":   "è·å–æ­å­å›¢é˜Ÿåˆ—è¡¨å¤±è´¥",
			"details": err.Error(),
		})
		return
	}

	c.JSON(http.StatusOK, gin.H{
		"message":  "è·å–æ­å­å›¢é˜Ÿåˆ—è¡¨æˆåŠŸ",
		"data":     teams,
		"has_more": hasMore,
		"page":     page,
		"limit":    limit,
	})
}

// GetTeamByID è·å–æ­å­å›¢é˜Ÿè¯¦æƒ…
func (h *Handlers) GetTeamByID(c *gin.Context) {
	teamIDStr := c.Param("id")
	teamID, err := strconv.ParseUint(teamIDStr, 10, 64)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": "æ— æ•ˆçš„å›¢é˜ŸID"})
		return
	}

	team, err := h.teamService.GetTeamByID(uint(teamID))
	if err != nil {
		c.JSON(http.StatusNotFound, gin.H{
			"error":   "è·å–å›¢é˜Ÿè¯¦æƒ…å¤±è´¥",
			"details": err.Error(),
		})
		return
	}

	c.JSON(http.StatusOK, gin.H{
		"message": "è·å–å›¢é˜Ÿè¯¦æƒ…æˆåŠŸ",
		"data":    team,
	})
}

// JoinTeam åŠ å…¥æ­å­å›¢é˜Ÿ
func (h *Handlers) JoinTeam(c *gin.Context) {
	teamIDStr := c.Param("id")
	teamID, err := strconv.ParseUint(teamIDStr, 10, 64)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": "æ— æ•ˆçš„å›¢é˜ŸID"})
		return
	}

	userIDStr := c.GetString("user_id")
	userID, err := strconv.ParseUint(userIDStr, 10, 64)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": "æ— æ•ˆçš„ç”¨æˆ·ID"})
		return
	}

	var req models.JoinTeamRequest
	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	err = h.teamService.JoinTeam(uint(teamID), uint(userID), &req)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{
			"error":   "åŠ å…¥å›¢é˜Ÿå¤±è´¥",
			"details": err.Error(),
		})
		return
	}

	c.JSON(http.StatusOK, gin.H{
		"message": "åŠ å…¥å›¢é˜ŸæˆåŠŸ",
	})
}

func (h *Handlers) GetProfile(c *gin.Context) {
	userIDStr := c.GetString("user_id")
	userID, err := strconv.ParseUint(userIDStr, 10, 64)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": "æ— æ•ˆçš„ç”¨æˆ·ID"})
		return
	}

	user, err := h.userService.GetByID(uint(userID))
	if err != nil {
		c.JSON(http.StatusNotFound, gin.H{"error": "ç”¨æˆ·ä¸å­˜åœ¨"})
		return
	}

	c.JSON(http.StatusOK, gin.H{"user": user})
}

func (h *Handlers) UpdateProfile(c *gin.Context) {
	userIDStr := c.GetString("user_id")
	userID, err := strconv.ParseUint(userIDStr, 10, 64)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": "æ— æ•ˆçš„ç”¨æˆ·ID"})
		return
	}

	var req models.UpdateProfileRequest
	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	err = h.userService.UpdateProfile(uint(userID), &req)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	c.JSON(http.StatusOK, gin.H{
		"message": "æ›´æ–°æˆåŠŸ",
	})
}

func (h *Handlers) UploadAvatar(c *gin.Context) {
	userIDStr := c.GetString("user_id")
	userID, err := strconv.ParseUint(userIDStr, 10, 64)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": "æ— æ•ˆçš„ç”¨æˆ·ID"})
		return
	}

	file, err := c.FormFile("avatar")
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": "è¯·é€‰æ‹©å¤´åƒæ–‡ä»¶"})
		return
	}

	// è¿™é‡Œéœ€è¦å®ç°æ–‡ä»¶ä¸Šä¼ é€»è¾‘
	avatarURL := "/uploads/avatars/" + file.Filename
	err = h.userService.UploadAvatar(uint(userID), avatarURL)
	if err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()})
		return
	}

	c.JSON(http.StatusOK, gin.H{
		"message":    "å¤´åƒä¸Šä¼ æˆåŠŸ",
		"avatar_url": avatarURL,
	})
}

// è®­ç»ƒç›¸å…³API
func (h *Handlers) GetTodayPlan(c *gin.Context) {
	userIDStr := c.GetString("user_id")
	userID, err := strconv.ParseUint(userIDStr, 10, 64)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": "æ— æ•ˆçš„ç”¨æˆ·ID"})
		return
	}

	plan, err := h.trainingService.GetTodayPlan(uint(userID))
	if err != nil {
		c.JSON(http.StatusNotFound, gin.H{"error": "ä»Šæ—¥æ— è®­ç»ƒè®¡åˆ’"})
		return
	}

	c.JSON(http.StatusOK, gin.H{"plan": plan})
}

func (h *Handlers) GetHistoryPlans(c *gin.Context) {
	userIDStr := c.GetString("user_id")

	page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
	limit, _ := strconv.Atoi(c.DefaultQuery("limit", "10"))

	plans, total, err := h.trainingService.GetHistoryPlans(userIDStr, page, limit)
	if err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()})
		return
	}

	c.JSON(http.StatusOK, gin.H{
		"plans": plans,
		"total": total,
		"page":  page,
		"limit": limit,
	})
}

func (h *Handlers) CreatePlan(c *gin.Context) {
	userIDStr := c.GetString("user_id")
	userID, err := strconv.ParseUint(userIDStr, 10, 64)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": "æ— æ•ˆçš„ç”¨æˆ·ID"})
		return
	}

	var req models.CreatePlanRequest
	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	plan, err := h.trainingService.CreatePlan(&models.TrainingPlan{
		ID:          fmt.Sprintf("plan_%d", time.Now().Unix()),
		UserID:      fmt.Sprintf("%d", userID),
		Name:        req.Name,
		Description: req.Description,
		Date:        time.Now(),
	})
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	c.JSON(http.StatusCreated, gin.H{
		"message": "è®­ç»ƒè®¡åˆ’åˆ›å»ºæˆåŠŸ",
		"plan":    plan,
	})
}

func (h *Handlers) UpdatePlan(c *gin.Context) {
	planID := c.Param("id")

	var req models.UpdatePlanRequest
	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	err := h.trainingService.UpdatePlan(planID, &models.TrainingPlan{
		Name:        req.Name,
		Description: req.Description,
	})
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	c.JSON(http.StatusOK, gin.H{
		"message": "è®­ç»ƒè®¡åˆ’æ›´æ–°æˆåŠŸ",
	})
}

func (h *Handlers) DeletePlan(c *gin.Context) {
	planID := c.Param("id")

	err := h.trainingService.DeletePlan(planID)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	c.JSON(http.StatusOK, gin.H{"message": "è®­ç»ƒè®¡åˆ’åˆ é™¤æˆåŠŸ"})
}

func (h *Handlers) GenerateAIPlan(c *gin.Context) {
	userIDStr := c.GetString("user_id")
	userID, err := strconv.ParseUint(userIDStr, 10, 64)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": "æ— æ•ˆçš„ç”¨æˆ·ID"})
		return
	}

	var req models.GenerateAIPlanRequest
	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	// è½¬æ¢è¯·æ±‚ç±»å‹
	trainingReq := &models.GenerateTrainingPlanRequest{
		Goal:       req.Goal,
		Duration:   req.Duration,
		Difficulty: req.Difficulty,
		Equipment:  req.Equipment,
		FocusAreas: req.FocusAreas,
	}

	plan, err := h.trainingService.GenerateAIPlan(uint(userID), trainingReq)
	if err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()})
		return
	}

	c.JSON(http.StatusOK, gin.H{
		"message": "AIè®­ç»ƒè®¡åˆ’ç”ŸæˆæˆåŠŸ",
		"plan":    plan,
	})
}

func (h *Handlers) CompleteExercise(c *gin.Context) {
	userID := c.GetString("user_id")
	exerciseID := c.Param("id")

	var req models.CompleteExerciseRequest
	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	err := h.trainingService.CompleteExercise(exerciseID, userID)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	c.JSON(http.StatusOK, gin.H{"message": "åŠ¨ä½œå®Œæˆè®°å½•æˆåŠŸ"})
}

func (h *Handlers) CompleteWorkout(c *gin.Context) {
	userID := c.GetString("user_id")

	var req models.CompleteWorkoutRequest
	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	err := h.trainingService.CompleteWorkout(req.PlanID, userID)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	c.JSON(http.StatusOK, gin.H{"message": "è®­ç»ƒå®Œæˆè®°å½•æˆåŠŸ"})
}

// ç¤¾åŒºç›¸å…³API
func (h *Handlers) GetFollowingPosts(c *gin.Context) {
	userID := c.GetString("user_id")

	page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
	limit, _ := strconv.Atoi(c.DefaultQuery("limit", "10"))

	posts, hasMore, err := // h.communityService.GetFollowingPosts(userID, page, limit, "")
	if err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()})
		return
	}

	c.JSON(http.StatusOK, gin.H{
		"posts":    posts,
		"has_more": hasMore,
		"page":     page,
		"limit":    limit,
	})
}

func (h *Handlers) GetRecommendPosts(c *gin.Context) {
	userID := c.GetString("user_id")

	page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
	limit, _ := strconv.Atoi(c.DefaultQuery("limit", "10"))

	posts, hasMore, err := // h.communityService.GetRecommendPosts(userID, page, limit, "")
	if err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()})
		return
	}

	c.JSON(http.StatusOK, gin.H{
		"posts":    posts,
		"has_more": hasMore,
		"page":     page,
		"limit":    limit,
	})
}

func (h *Handlers) CreatePost(c *gin.Context) {
	userIDStr := c.GetString("user_id")
	userID, err := strconv.ParseUint(userIDStr, 10, 64)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": "æ— æ•ˆçš„ç”¨æˆ·ID"})
		return
	}

	var req models.CreatePostRequest
	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	// å°†[]stringè½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
	imagesJSON, _ := json.Marshal(req.Images)
	tagsJSON, _ := json.Marshal(req.Tags)
	workoutDataJSON, _ := json.Marshal(req.WorkoutData)

	post, err := // h.communityService.CreatePost(&models.Post{
		UserID:      uint(userID),
		Content:     req.Content,
		Type:        req.Type,
		Images:      string(imagesJSON),
		VideoURL:    req.VideoURL,
		Tags:        string(tagsJSON),
		Location:    req.Location,
		WorkoutData: string(workoutDataJSON),
	})
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	c.JSON(http.StatusCreated, gin.H{
		"message": "å¸–å­å‘å¸ƒæˆåŠŸ",
		"post":    post,
	})
}

func (h *Handlers) GetPost(c *gin.Context) {
	postID := c.Param("id")

	post, err := // h.communityService.GetPost(postID)
	if err != nil {
		c.JSON(http.StatusNotFound, gin.H{"error": "å¸–å­ä¸å­˜åœ¨"})
		return
	}

	c.JSON(http.StatusOK, gin.H{"post": post})
}

func (h *Handlers) UpdatePost(c *gin.Context) {
	userID := c.GetString("user_id")
	postID := c.Param("id")

	var req models.UpdatePostRequest
	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	// UpdatePost æ–¹æ³•ä¸å­˜åœ¨ï¼Œæš‚æ—¶è¿”å›é”™è¯¯
	_ = userID
	_ = postID
	c.JSON(http.StatusNotImplemented, gin.H{"error": "æ›´æ–°å¸–å­åŠŸèƒ½æš‚æœªå®ç°"})
	return
}

func (h *Handlers) DeletePost(c *gin.Context) {
	userID := c.GetString("user_id")
	postID := c.Param("id")

	// DeletePost æ–¹æ³•ä¸å­˜åœ¨ï¼Œæš‚æ—¶è¿”å›é”™è¯¯
	_ = userID
	_ = postID
	c.JSON(http.StatusNotImplemented, gin.H{"error": "åˆ é™¤å¸–å­åŠŸèƒ½æš‚æœªå®ç°"})
	return
}

func (h *Handlers) LikePost(c *gin.Context) {
	userID := c.GetString("user_id")
	postID := c.Param("id")

	err := // h.communityService.LikePost(postID, userID)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	c.JSON(http.StatusOK, gin.H{"message": "æ“ä½œæˆåŠŸ"})
}

func (h *Handlers) CommentPost(c *gin.Context) {
	userID := c.GetString("user_id")
	postID := c.Param("id")

	var req models.CreateCommentRequest
	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	comment, err := // h.communityService.CreateComment(postID, userID, req.Content)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	c.JSON(http.StatusCreated, gin.H{
		"message": "è¯„è®ºæˆåŠŸ",
		"comment": comment,
	})
}

func (h *Handlers) SharePost(c *gin.Context) {
	userID := c.GetString("user_id")
	postID := c.Param("id")

	// SharePost æ–¹æ³•ä¸å­˜åœ¨ï¼Œæš‚æ—¶è¿”å›é”™è¯¯
	_ = userID
	_ = postID
	c.JSON(http.StatusNotImplemented, gin.H{"error": "åˆ†äº«å¸–å­åŠŸèƒ½æš‚æœªå®ç°"})
	return
}

func (h *Handlers) GetTrendingTopics(c *gin.Context) {
	topics, err := // h.communityService.GetTrendingTopics(10)
	if err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()})
		return
	}

	c.JSON(http.StatusOK, gin.H{"topics": topics})
}

func (h *Handlers) FollowUser(c *gin.Context) {
	userID := c.GetString("user_id")
	followUserID := c.Param("id")

	err := // h.communityService.FollowUser(userID, followUserID)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	c.JSON(http.StatusOK, gin.H{"message": "å…³æ³¨æˆåŠŸ"})
}

func (h *Handlers) UnfollowUser(c *gin.Context) {
	userID := c.GetString("user_id")
	followUserID := c.Param("id")

	err := // h.communityService.UnfollowUser(userID, followUserID)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	c.JSON(http.StatusOK, gin.H{"message": "å–æ¶ˆå…³æ³¨æˆåŠŸ"})
}

// æ¶ˆæ¯ç›¸å…³API
func (h *Handlers) GetChats(c *gin.Context) {
	userIDStr := c.GetString("user_id")
	_, err := strconv.ParseUint(userIDStr, 10, 32)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{
			"error": "æ— æ•ˆçš„ç”¨æˆ·ID",
		})
		return
	}

	chats, err := h.messageService.GetChats(userIDStr)
	if err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{
			"error":   "è·å–èŠå¤©åˆ—è¡¨å¤±è´¥",
			"details": err.Error(),
		})
		return
	}

	c.JSON(http.StatusOK, gin.H{
		"message": "è·å–èŠå¤©åˆ—è¡¨æˆåŠŸ",
		"data":    chats,
	})
}

func (h *Handlers) GetChatMessages(c *gin.Context) {
	userID := c.GetString("user_id")
	chatID := c.Param("id")

	// MessageService æš‚æœªå®ç°
	_ = userID
	_ = chatID
	c.JSON(http.StatusNotImplemented, gin.H{"error": "æ¶ˆæ¯åŠŸèƒ½æš‚æœªå®ç°"})
	return
}

func (h *Handlers) CreateChat(c *gin.Context) {
	userIDStr := c.GetString("user_id")
	userID, err := strconv.ParseUint(userIDStr, 10, 32)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{
			"error": "æ— æ•ˆçš„ç”¨æˆ·ID",
		})
		return
	}

	var req models.CreateChatRequest
	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{
			"error": err.Error(),
		})
		return
	}

	chat, err := h.messageService.CreateChat(uint(userID), &req)
	if err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{
			"error":   "åˆ›å»ºèŠå¤©å¤±è´¥",
			"details": err.Error(),
		})
		return
	}

	c.JSON(http.StatusCreated, gin.H{
		"message": "åˆ›å»ºèŠå¤©æˆåŠŸ",
		"data":    chat,
	})
}

func (h *Handlers) SendMessage(c *gin.Context) {
	chatIDStr := c.Param("id")
	chatID, err := strconv.ParseUint(chatIDStr, 10, 32)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{
			"error": "æ— æ•ˆçš„èŠå¤©ID",
		})
		return
	}

	userIDStr := c.GetString("user_id")
	userID, err := strconv.ParseUint(userIDStr, 10, 32)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{
			"error": "æ— æ•ˆçš„ç”¨æˆ·ID",
		})
		return
	}

	var req models.SendMessageRequest
	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{
			"error": err.Error(),
		})
		return
	}

	message, err := h.messageService.SendMessage(uint(chatID), uint(userID), &req)
	if err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{
			"error":   "å‘é€æ¶ˆæ¯å¤±è´¥",
			"details": err.Error(),
		})
		return
	}

	c.JSON(http.StatusCreated, gin.H{
		"message": "å‘é€æ¶ˆæ¯æˆåŠŸ",
		"data":    message,
	})
}

func (h *Handlers) GetNotifications(c *gin.Context) {
	userIDStr := c.GetString("user_id")
	_, err := strconv.ParseUint(userIDStr, 10, 32)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{
			"error": "æ— æ•ˆçš„ç”¨æˆ·ID",
		})
		return
	}

	notifications, err := h.messageService.GetNotifications(userIDStr)
	if err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{
			"error":   "è·å–é€šçŸ¥å¤±è´¥",
			"details": err.Error(),
		})
		return
	}

	c.JSON(http.StatusOK, gin.H{
		"message": "è·å–é€šçŸ¥æˆåŠŸ",
		"data":    notifications,
	})
}

func (h *Handlers) MarkNotificationRead(c *gin.Context) {
	userID := c.GetString("user_id")
	notificationID := c.Param("id")

	// MessageService æš‚æœªå®ç°
	_ = userID
	_ = notificationID
	c.JSON(http.StatusNotImplemented, gin.H{"error": "æ¶ˆæ¯åŠŸèƒ½æš‚æœªå®ç°"})
	return
}

func (h *Handlers) ClearNotifications(c *gin.Context) {
	userID := c.GetString("user_id")

	// MessageService æš‚æœªå®ç°
	_ = userID
	c.JSON(http.StatusNotImplemented, gin.H{"error": "æ¶ˆæ¯åŠŸèƒ½æš‚æœªå®ç°"})
	return
}

func (h *Handlers) GetSystemMessages(c *gin.Context) {
	userID := c.GetString("user_id")

	// MessageService æš‚æœªå®ç°
	_ = userID
	c.JSON(http.StatusNotImplemented, gin.H{"error": "æ¶ˆæ¯åŠŸèƒ½æš‚æœªå®ç°"})
	return
}

// AIç›¸å…³API
func (h *Handlers) GenerateTrainingPlan(c *gin.Context) {
	userID := c.GetString("user_id")

	var req models.GenerateTrainingPlanRequest
	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	// è½¬æ¢è¯·æ±‚ç±»å‹
	workoutReq := services.WorkoutPlanRequest{
		Goal:        req.Goal,
		Duration:    req.Duration,
		Difficulty:  req.Difficulty,
		Experience:  "ä¸­çº§",   // é»˜è®¤å€¼
		Equipment:   "åŸºç¡€å™¨æ¢°", // é»˜è®¤å€¼
		TimePerDay:  req.Duration,
		Preferences: "å…¨èº«è®­ç»ƒ", // é»˜è®¤å€¼
	}

	// è®°å½•ç”¨æˆ·IDç”¨äºæ—¥å¿—
	_ = userID

	plan, err := h.aiService.GenerateTrainingPlan(workoutReq)
	if err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()})
		return
	}

	c.JSON(http.StatusOK, gin.H{
		"message": "AIè®­ç»ƒè®¡åˆ’ç”ŸæˆæˆåŠŸ",
		"plan":    plan,
	})
}

func (h *Handlers) GenerateNutritionPlan(c *gin.Context) {
	userID := c.GetString("user_id")

	var req models.GenerateNutritionPlanRequest
	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	// GenerateNutritionPlan æ–¹æ³•ä¸å­˜åœ¨ï¼Œæš‚æ—¶è¿”å›é”™è¯¯
	_ = userID
	_ = req
	c.JSON(http.StatusNotImplemented, gin.H{"error": "è¥å…»è®¡åˆ’åŠŸèƒ½æš‚æœªå®ç°"})
	return
}

func (h *Handlers) AIChat(c *gin.Context) {
	userID := c.GetString("user_id")

	var req models.AIChatRequest
	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	// AIChat æ–¹æ³•ä¸å­˜åœ¨ï¼Œæš‚æ—¶è¿”å›é”™è¯¯
	_ = userID
	_ = req
	c.JSON(http.StatusNotImplemented, gin.H{"error": "AIèŠå¤©åŠŸèƒ½æš‚æœªå®ç°"})
	return
}

// StartWorkout å¼€å§‹è®­ç»ƒ
func (h *Handlers) StartWorkout(c *gin.Context) {
	userID := c.GetString("user_id")
	if userID == "" {
		c.JSON(http.StatusUnauthorized, gin.H{"error": "æœªæˆæƒè®¿é—®"})
		return
	}

	var req struct {
		PlanID string `json:"plan_id" binding:"required"`
	}

	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	// å¼€å§‹è®­ç»ƒé€»è¾‘
	c.JSON(http.StatusOK, gin.H{
		"success": true,
		"message": "è®­ç»ƒå¼€å§‹ï¼",
		"data": gin.H{
			"workout_id": fmt.Sprintf("workout_%d", time.Now().Unix()),
			"start_time": time.Now(),
		},
	})
}

// GetTrainingStats è·å–è®­ç»ƒç»Ÿè®¡
func (h *Handlers) GetTrainingStats(c *gin.Context) {
	userID := c.GetString("user_id")
	if userID == "" {
		c.JSON(http.StatusUnauthorized, gin.H{"error": "æœªæˆæƒè®¿é—®"})
		return
	}

	// è·å–æŸ¥è¯¢å‚æ•°
	period := c.DefaultQuery("period", "week") // week, month, year

	stats := gin.H{
		"current_streak":        7,
		"total_calories_burned": 1500,
		"total_workouts":        12,
		"period":                period,
		"workouts_this_period":  3,
		"calories_this_period":  450,
		"avg_duration":          45,
		"favorite_exercise":     "ä¿¯å§æ’‘",
	}

	c.JSON(http.StatusOK, gin.H{
		"success": true,
		"data":    stats,
	})
}

// GetAchievements è·å–æˆå°±åˆ—è¡¨
func (h *Handlers) GetAchievements(c *gin.Context) {
	userID := c.GetString("user_id")
	if userID == "" {
		c.JSON(http.StatusUnauthorized, gin.H{"error": "æœªæˆæƒè®¿é—®"})
		return
	}

	achievements := []gin.H{
		{
			"id":          "achievement_1",
			"name":        "è®­ç»ƒæ–°æ‰‹",
			"description": "å®Œæˆç¬¬ä¸€æ¬¡è®­ç»ƒ",
			"icon":        "ğŸ†",
			"is_claimed":  true,
			"points":      10,
		},
		{
			"id":          "achievement_2",
			"name":        "åšæŒä¸€å‘¨",
			"description": "è¿ç»­è®­ç»ƒ7å¤©",
			"icon":        "ğŸ”¥",
			"is_claimed":  false,
			"points":      50,
		},
		{
			"id":          "achievement_3",
			"name":        "å¡è·¯é‡Œç‡ƒçƒ§è€…",
			"description": "å•æ¬¡è®­ç»ƒæ¶ˆè€—500å¡è·¯é‡Œ",
			"icon":        "ğŸ’ª",
			"is_claimed":  false,
			"points":      30,
		},
	}

	c.JSON(http.StatusOK, gin.H{
		"success": true,
		"data": gin.H{
			"achievements": achievements,
		},
	})
}

// ClaimAchievement é¢†å–æˆå°±å¥–åŠ±
func (h *Handlers) ClaimAchievement(c *gin.Context) {
	userID := c.GetString("user_id")
	if userID == "" {
		c.JSON(http.StatusUnauthorized, gin.H{"error": "æœªæˆæƒè®¿é—®"})
		return
	}

	achievementID := c.Param("id")
	if achievementID == "" {
		c.JSON(http.StatusBadRequest, gin.H{"error": "æˆå°±IDä¸èƒ½ä¸ºç©º"})
		return
	}

	// é¢†å–æˆå°±é€»è¾‘
	c.JSON(http.StatusOK, gin.H{
		"success": true,
		"message": "æˆå°±å¥–åŠ±é¢†å–æˆåŠŸï¼",
		"data": gin.H{
			"achievement_id": achievementID,
			"points_earned":  50,
		},
	})
}

// GetCheckIns è·å–æ‰“å¡è®°å½•
func (h *Handlers) GetCheckIns(c *gin.Context) {
	userID := c.GetString("user_id")
	if userID == "" {
		c.JSON(http.StatusUnauthorized, gin.H{"error": "æœªæˆæƒè®¿é—®"})
		return
	}

	// è·å–æŸ¥è¯¢å‚æ•°
	page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
	limit, _ := strconv.Atoi(c.DefaultQuery("limit", "30"))

	checkIns := []gin.H{
		{
			"id":         "checkin_1",
			"date":       time.Now().AddDate(0, 0, -1),
			"type":       "è®­ç»ƒ",
			"content":    "å®Œæˆäº†ä»Šå¤©çš„è®­ç»ƒè®¡åˆ’",
			"images":     []string{},
			"location":   "å¥èº«æˆ¿",
			"created_at": time.Now().AddDate(0, 0, -1),
		},
		{
			"id":         "checkin_2",
			"date":       time.Now().AddDate(0, 0, -2),
			"type":       "æ—¥å¸¸",
			"content":    "ä»Šå¤©å¿ƒæƒ…å¾ˆå¥½",
			"images":     []string{},
			"location":   "å®¶é‡Œ",
			"created_at": time.Now().AddDate(0, 0, -2),
		},
	}

	c.JSON(http.StatusOK, gin.H{
		"success": true,
		"data": gin.H{
			"checkins":   checkIns,
			"total":      len(checkIns),
			"page":       page,
			"limit":      limit,
			"total_page": 1,
		},
	})
}

// CreateCheckIn åˆ›å»ºæ‰“å¡è®°å½•
func (h *Handlers) CreateCheckIn(c *gin.Context) {
	userID := c.GetString("user_id")
	if userID == "" {
		c.JSON(http.StatusUnauthorized, gin.H{"error": "æœªæˆæƒè®¿é—®"})
		return
	}

	var req struct {
		Type     string   `json:"type" binding:"required"`
		Content  string   `json:"content"`
		Images   []string `json:"images"`
		Location string   `json:"location"`
	}

	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	checkIn := gin.H{
		"id":         fmt.Sprintf("checkin_%d", time.Now().Unix()),
		"user_id":    userID,
		"date":       time.Now(),
		"type":       req.Type,
		"content":    req.Content,
		"images":     req.Images,
		"location":   req.Location,
		"created_at": time.Now(),
	}

	c.JSON(http.StatusCreated, gin.H{
		"success": true,
		"message": "æ‰“å¡æˆåŠŸï¼",
		"data":    checkIn,
	})
}

// GetProfileActivities è·å–ç”¨æˆ·æ´»åŠ¨è®°å½•
func (h *Handlers) GetProfileActivities(c *gin.Context) {
	userID := c.GetString("user_id")
	if userID == "" {
		c.JSON(http.StatusUnauthorized, gin.H{"error": "æœªæˆæƒè®¿é—®"})
		return
	}

	activities := []gin.H{
		{
			"id":          "activity_1",
			"type":        "è®­ç»ƒ",
			"title":       "å®Œæˆä»Šæ—¥è®­ç»ƒ",
			"description": "å®Œæˆäº†30åˆ†é’Ÿçš„åŠ›é‡è®­ç»ƒ",
			"date":        time.Now().AddDate(0, 0, -1),
			"points":      50,
		},
		{
			"id":          "activity_2",
			"type":        "æ‰“å¡",
			"title":       "è¿ç»­æ‰“å¡7å¤©",
			"description": "è·å¾—åšæŒä¸€å‘¨æˆå°±",
			"date":        time.Now().AddDate(0, 0, -2),
			"points":      100,
		},
	}

	c.JSON(http.StatusOK, gin.H{
		"success": true,
		"data":    activities,
	})
}

// GetCurrentPlan è·å–å½“å‰è®­ç»ƒè®¡åˆ’
func (h *Handlers) GetCurrentPlan(c *gin.Context) {
	userID := c.GetString("user_id")
	if userID == "" {
		c.JSON(http.StatusUnauthorized, gin.H{"error": "æœªæˆæƒè®¿é—®"})
		return
	}

	plan := gin.H{
		"id":          "plan_current",
		"name":        "å‡è„‚å¡‘å½¢è®¡åˆ’",
		"description": "30å¤©å‡è„‚å¡‘å½¢è®­ç»ƒè®¡åˆ’",
		"duration":    30,
		"progress":    15,
		"start_date":  time.Now().AddDate(0, 0, -15),
		"end_date":    time.Now().AddDate(0, 0, 15),
		"exercises": []gin.H{
			{
				"name":      "ä¿¯å§æ’‘",
				"sets":      3,
				"reps":      15,
				"completed": true,
			},
			{
				"name":      "æ·±è¹²",
				"sets":      3,
				"reps":      20,
				"completed": false,
			},
		},
	}

	c.JSON(http.StatusOK, gin.H{
		"success": true,
		"data":    plan,
	})
}

// GetPlanHistory è·å–è®­ç»ƒè®¡åˆ’å†å²
func (h *Handlers) GetPlanHistory(c *gin.Context) {
	userID := c.GetString("user_id")
	if userID == "" {
		c.JSON(http.StatusUnauthorized, gin.H{"error": "æœªæˆæƒè®¿é—®"})
		return
	}

	history := []gin.H{
		{
			"id":         "plan_1",
			"name":       "å¢è‚Œè®­ç»ƒè®¡åˆ’",
			"duration":   28,
			"completed":  true,
			"start_date": time.Now().AddDate(0, 0, -60),
			"end_date":   time.Now().AddDate(0, 0, -32),
			"rating":     4,
		},
		{
			"id":         "plan_2",
			"name":       "æœ‰æ°§è®­ç»ƒè®¡åˆ’",
			"duration":   14,
			"completed":  true,
			"start_date": time.Now().AddDate(0, 0, -45),
			"end_date":   time.Now().AddDate(0, 0, -31),
			"rating":     5,
		},
	}

	c.JSON(http.StatusOK, gin.H{
		"success": true,
		"data":    history,
	})
}

// GetNutritionPlan è·å–è¥å…»è®¡åˆ’
func (h *Handlers) GetNutritionPlan(c *gin.Context) {
	userID := c.GetString("user_id")
	if userID == "" {
		c.JSON(http.StatusUnauthorized, gin.H{"error": "æœªæˆæƒè®¿é—®"})
		return
	}

	nutritionPlan := gin.H{
		"id":             "nutrition_1",
		"goal":           "å‡è„‚",
		"daily_calories": 1800,
		"protein":        120,
		"carbs":          180,
		"fat":            60,
		"meals": []gin.H{
			{
				"meal":     "æ—©é¤",
				"calories": 400,
				"foods":    []string{"ç‡•éº¦", "ç‰›å¥¶", "é¦™è•‰"},
			},
			{
				"meal":     "åˆé¤",
				"calories": 600,
				"foods":    []string{"é¸¡èƒ¸è‚‰", "ç±³é¥­", "è”¬èœ"},
			},
			{
				"meal":     "æ™šé¤",
				"calories": 500,
				"foods":    []string{"é±¼è‚‰", "è”¬èœæ²™æ‹‰"},
			},
			{
				"meal":     "åŠ é¤",
				"calories": 300,
				"foods":    []string{"åšæœ", "é…¸å¥¶"},
			},
		},
	}

	c.JSON(http.StatusOK, gin.H{
		"success": true,
		"data":    nutritionPlan,
	})
}

// UpdateNutritionPlan æ›´æ–°è¥å…»è®¡åˆ’
func (h *Handlers) UpdateNutritionPlan(c *gin.Context) {
	userID := c.GetString("user_id")
	if userID == "" {
		c.JSON(http.StatusUnauthorized, gin.H{"error": "æœªæˆæƒè®¿é—®"})
		return
	}

	var req struct {
		Goal          string `json:"goal"`
		DailyCalories int    `json:"daily_calories"`
		Protein       int    `json:"protein"`
		Carbs         int    `json:"carbs"`
		Fat           int    `json:"fat"`
	}

	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	c.JSON(http.StatusOK, gin.H{
		"success": true,
		"message": "è¥å…»è®¡åˆ’æ›´æ–°æˆåŠŸï¼",
		"data": gin.H{
			"goal":           req.Goal,
			"daily_calories": req.DailyCalories,
			"protein":        req.Protein,
			"carbs":          req.Carbs,
			"fat":            req.Fat,
		},
	})
}

// GetProfileSettings è·å–ç”¨æˆ·è®¾ç½®
func (h *Handlers) GetProfileSettings(c *gin.Context) {
	userID := c.GetString("user_id")
	if userID == "" {
		c.JSON(http.StatusUnauthorized, gin.H{"error": "æœªæˆæƒè®¿é—®"})
		return
	}

	settings := gin.H{
		"notifications": gin.H{
			"workout_reminder": true,
			"achievement":      true,
			"social":           false,
		},
		"privacy": gin.H{
			"profile_public":  true,
			"show_activities": true,
			"show_stats":      false,
		},
		"units": gin.H{
			"weight":   "kg",
			"height":   "cm",
			"distance": "km",
		},
		"language": "zh-CN",
		"theme":    "light",
	}

	c.JSON(http.StatusOK, gin.H{
		"success": true,
		"data":    settings,
	})
}

// UpdateProfileSetting æ›´æ–°ç”¨æˆ·è®¾ç½®
func (h *Handlers) UpdateProfileSetting(c *gin.Context) {
	userID := c.GetString("user_id")
	if userID == "" {
		c.JSON(http.StatusUnauthorized, gin.H{"error": "æœªæˆæƒè®¿é—®"})
		return
	}

	settingKey := c.Param("key")
	if settingKey == "" {
		c.JSON(http.StatusBadRequest, gin.H{"error": "è®¾ç½®é”®ä¸èƒ½ä¸ºç©º"})
		return
	}

	var req struct {
		Value interface{} `json:"value"`
	}

	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}

	c.JSON(http.StatusOK, gin.H{
		"success": true,
		"message": "è®¾ç½®æ›´æ–°æˆåŠŸï¼",
		"data": gin.H{
			"key":   settingKey,
			"value": req.Value,
		},
	})
}
